# 有限体 F_p 上の楕円曲線 E: y^2 = x^3 + a x + b の点を列挙して散布図で描く
# -----------------------------------------------------------------------------
# 目的
# - 楕円曲線暗号（ECC）が扱う「有限体上の楕円曲線の点集合」を、実際に列挙して可視化する。
# - 実数上の楕円曲線は連続な曲線だが、有限体 F_p 上では点が離散的に存在する。
# - その “点の散らばり方” を視覚的に確認するための学習用コードである。
#
# 対象の曲線（mod p）
# - ここでは p=599, a=1, b=0 として
#
#     E: y^2 ≡ x^3 + x   (mod 599)
#
# を扱う（Weierstrass 形式）。
#
# -----------------------------------------------------------------------------
# アルゴリズム（中心）
# -----------------------------------------------------------------------------
# 有限体 F_p（p は素数）上で、各 x ∈ {0,1,...,p-1} について
#
#   RHS = x^3 + a x + b (mod p)
#
# を計算し、その RHS が平方剰余（quadratic residue）なら y が存在する：
#
#   y^2 ≡ RHS (mod p)
#
# - RHS が平方剰余なら、平方根 y は一般に 2 つ（y と -y）存在する。
#   mod p では -y は (p - y) として表せるので、(x,y) と (x,p-y) の2点をプロットする。
# - RHS ≡ 0 の場合は y=0 の1点だけ。
# - RHS が平方非剰余なら y は存在しないので点はない。
#
# 平方剰余判定にはルジャンドル記号を使う：
# - Legendre(RHS, p) が
#   1 なら平方剰余（平方根あり）
#   0 なら RHS≡0
#  -1 なら平方非剰余（平方根なし）
#
# -----------------------------------------------------------------------------
# modsqrt の前提（重要）
# -----------------------------------------------------------------------------
# このコードの modsqrt は
#
#   y ≡ RHS^{(p+1)/4} (mod p)
#
# を使って平方根を計算している。
# これは p≡3(mod4) のときだけ成立する「簡単ケース」である。
#
# したがって、このコードは p が
#
#   p % 4 == 3
#
# を満たす必要がある。
# p=599 は 599 % 4 = 3 なのでこの条件を満たす。
#
# -----------------------------------------------------------------------------
# 描画について
# -----------------------------------------------------------------------------
# - plt.scatter(x,y) で有限体上の点を 2D 平面上にプロットする。
# - ここでの “距離” や “曲線の形” は実数の幾何とは別物だが、
#   点がどの x に対して存在するか、2点対称に出るか、といった構造が直感的に見える。


import matplotlib.pyplot as plt


def Legendre(a, p):
    # ルジャンドル記号 (a/p) を Euler の判定法で計算する。
    #
    # Euler の判定法：
    #   a^{(p-1)/2} ≡
    #     0  (mod p)  if a≡0
    #     1  (mod p)  if a is quadratic residue
    #    -1  (mod p)  otherwise
    #
    # pow は 0..p-1 の剰余で返すため、p-1 を -1 に正規化して返している。
    L = pow(a, (p - 1) // 2, p)
    if L == p - 1:
        L = -1
    return L


def f(x, a, b, p):
    # 楕円曲線の右辺 RHS = x^3 + a x + b を mod p で計算する。
    #
    # 曲線： y^2 ≡ RHS (mod p)
    ysq = (x**3 + a * x + b) % p
    return ysq


# -----------------------------------------------------------------------------
# パラメータ設定
# -----------------------------------------------------------------------------
p = 599  # 素数（有限体 F_p）
a = 1
b = 0    # 曲線は y^2 ≡ x^3 + x (mod 599)


def modsqrt(c, p):
    # mod p における平方根計算（p≡3(mod4) の簡単ケース）
    #
    # もし p = 4k+3 なら、平方剰余 c に対し
    #   y = c^{(p+1)/4} mod p
    # が平方根になる（y^2 ≡ c）。
    #
    # 注意：p%4!=3 の場合はこの方法は一般には使えない（Tonelli–Shanks 等が必要）。
    return pow(c, (p + 1) // 4, p)


# -----------------------------------------------------------------------------
# 点の列挙とプロット
# -----------------------------------------------------------------------------
# x を 0..p-1 で総当たりし、対応する y を見つけて点を描く。
for x in range(p):
    # RHS を計算
    ysq = f(x, a, b, p)

    # ysq が平方剰余か判定
    Leg = Legendre(ysq, p)

    if Leg == 1:
        # ysq が平方剰余なので平方根が存在する
        y = modsqrt(ysq, p)

        # mod p では平方根は通常 2 個（y と -y）。
        # -y mod p は p-y（ただし y=0 のときは同じ点になる）
        plt.scatter(x, y, s=10, c="black")
        plt.scatter(x, p - y, s=10, c="black")

    elif Leg == 0:
        # ysq ≡ 0 (mod p) の場合は y=0 の1点だけ
        plt.scatter(x, 0, s=10, c="black")

    # Leg == -1 の場合は平方根が存在しないので点は描かない

# 描画
plt.show()
