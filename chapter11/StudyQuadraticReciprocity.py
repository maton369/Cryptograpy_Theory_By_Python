# ヤコビ記号 (Jacobi symbol) (a/n) を計算する（再帰版）
# -----------------------------------------------------------------------------
# 前提
# - n は正の奇数（n > 0 かつ n % 2 == 1）
# - a は任意の整数（負でもOK）
#
# ヤコビ記号とは
# - ルジャンドル記号 (a/p)（pが奇素数）を「奇数合成数 n」に一般化したもの。
# - n の素因数分解 n = Π p_i^{e_i} に対し、
#     (a/n) = Π (a/p_i)^{e_i}
#   として定義される（ただし (a/p_i) はルジャンドル記号）。
#
# 重要な注意（暗号理論で超大事）
# - (a/n) = 1 でも、a が n を法として平方剰余であるとは限らない（n が合成数の場合）。
#   つまり Jacobi=1 は「平方剰余の必要条件」であって十分条件ではない。
# - そのため Jacobi 記号は「平方剰余っぽさの判定」には使えるが、
#   「平方剰余であることの保証」にはならない（nが素数なら保証できる＝ルジャンドル記号）。
#
# 計算方法（アルゴリズムの核）
# - ヤコビ記号は以下の性質（合同・互除・相互法則）により高速に計算できる：
#
# (1) a を n で正規化できる： (a/n) = (a mod n / n)
# (2) 2 の因子の取り扱い：
#     (2/n) = +1  if n ≡ 1,7 (mod 8)
#           = -1  if n ≡ 3,5 (mod 8)
#     よって a が偶数なら a=2*a' として (a/n) = (2/n)*(a'/n)
# (3) 二次の相互法則（Quadratic Reciprocity）：
#     a,n が奇数で互いに素のとき
#       (a/n) = (n/a) * (-1)^{((a-1)/2)*((n-1)/2)}
#     ここで a≡n≡3 (mod 4) のときだけ符号が反転する：
#       a % 4 == 3 and n % 4 == 3 なら (a/n) = -(n/a)
#       それ以外は (a/n) = (n/a)
#
# 実装上の注意
# - 再帰の最後は (n mod a, a) に落とさないと無限再帰になる。
# - また a%=n を最初にやると a は 0..n-1 になり、a<0 分岐は起こらない。
#   「aが負でもOK」を正しく扱うには、符号処理→aの正規化、の順が分かりやすい。


def Jacobi(a, n):
    # -----------------------------
    # 入力チェック（最低限）
    # -----------------------------
    # n は正の奇数である必要がある。
    # 実務なら例外を投げるのが自然だが、学習用としてコメントで明示しておく。
    # if n <= 0 or n % 2 == 0:
    #     raise ValueError("n must be a positive odd integer")

    # -----------------------------
    # 0) a の符号処理
    # -----------------------------
    # (−a/n) の扱い：
    # ルジャンドル記号と同様に、n≡3 (mod 4) のときだけ符号が反転する。
    #
    #   (-1/n) = +1  if n ≡ 1 (mod 4)
    #          = -1  if n ≡ 3 (mod 4)
    #
    # よって a<0 のとき：
    #   (a/n) = (-1/n) * ((-a)/n)
    if a < 0:
        if n % 4 == 3:
            return -Jacobi(-a, n)
        else:
            return Jacobi(-a, n)

    # -----------------------------
    # 1) a を [0, n-1] に正規化
    # -----------------------------
    # Jacobi(a,n) は a を n で割った剰余だけ見れば良い。
    a = a % n

    # -----------------------------
    # 2) ベースケース
    # -----------------------------
    # a==0 なら (0/n)=0
    if a == 0:
        return 0
    # a==1 なら (1/n)=1
    if a == 1:
        return 1

    # -----------------------------
    # 3) a が偶数なら 2 をくくる
    # -----------------------------
    # a = 2 * a' として
    #   (a/n) = (2/n) * (a'/n)
    #
    # (2/n) の評価：
    #   (2/n) = +1  if n % 8 in {1,7}
    #         = -1  if n % 8 in {3,5}
    if a % 2 == 0:
        a_half = a // 2
        if n % 8 == 1 or n % 8 == 7:
            return Jacobi(a_half, n)
        else:
            return -Jacobi(a_half, n)

    # -----------------------------
    # 4) a, n がともに奇数になったので相互法則を適用
    # -----------------------------
    # a % 4 == 3 かつ n % 4 == 3 のときだけ符号反転：
    #   (a/n) = -(n/a)
    # それ以外は：
    #   (a/n) = +(n/a)
    #
    # さらに再帰の引数は (n mod a, a) に落とす（互除法的に小さくする）
    if (a % 4 == 3) and (n % 4 == 3):
        return -Jacobi(n % a, a)

    return Jacobi(n % a, a)
